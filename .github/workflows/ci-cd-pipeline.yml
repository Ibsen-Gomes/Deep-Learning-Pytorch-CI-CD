name: CI/CD for Deep Learning  # Nome do workflow

# Evento que aciona o workflow
on:
  push:
    branches:
      - main
      - feature/simulate-user  # üöÄ Adicionando a nova branch ao pipeline

jobs:
  test:
    runs-on: ubuntu-latest  # Define o ambiente de execu√ß√£o como a √∫ltima vers√£o do Ubuntu
    steps:
      - name: Checkout do c√≥digo  # Baixa o c√≥digo do reposit√≥rio
        uses: actions/checkout@v2

      - name: Configurar Python  # Configura o ambiente Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.9"  # Define a vers√£o do Python

      - name: Instalar depend√™ncias  # Instala as depend√™ncias listadas no arquivo requirements.txt
        run: pip install -r api/requirements.txt

      - name: Testar modelo  # Executa os testes unit√°rios para o modelo
        run: pytest tests/test_train.py

  train:
    needs: test  # O job de treinamento depende do job de teste
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v2

      - name: Configurar Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.9"

      - name: Instalar depend√™ncias
        run: pip install -r api/requirements.txt

      - name: Treinar modelo  # Treina o modelo utilizando o script especificado
        run: python model/train.py

      - name: Armazenar modelo treinado  # Armazena o modelo treinado como um artefato
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: model/model.pth

  deploy:
    needs: train  # O job de deploy depende do job de treinamento
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Define um tempo limite para o job
    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v2

      - name: Configurar Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.9"

      - name: Instalar depend√™ncias
        run: pip install -r api/requirements.txt

      - name: Baixar modelo treinado  # Baixa o modelo treinado armazenado no job anterior
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: model/

      - name: Rodar API com FastAPI  # Inicia a API utilizando o FastAPI
        run: uvicorn api.main:app --host 0.0.0.0 --port 8000 &  # Rodar em background

      - name: Simular um usu√°rio enviando uma imagem para a API  # Executa o script que simula um usu√°rio
        run: python user/simulate_user.py


        